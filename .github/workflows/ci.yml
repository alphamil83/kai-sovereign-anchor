name: KAI Sovereign Anchor CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ═══════════════════════════════════════════════════════════════
  # SMART CONTRACT TESTS
  # ═══════════════════════════════════════════════════════════════
  contract-tests:
    name: Charter Registry Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: chain/package-lock.json

      - name: Install dependencies
        working-directory: ./chain
        run: npm ci

      - name: Compile contracts
        working-directory: ./chain
        run: npm run compile

      - name: Run tests
        working-directory: ./chain
        run: npm test

  # ═══════════════════════════════════════════════════════════════
  # POLICY ENGINE TESTS
  # ═══════════════════════════════════════════════════════════════
  policy-engine-tests:
    name: Policy Engine Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: policy-engine/package-lock.json

      - name: Install dependencies
        working-directory: ./policy-engine
        run: npm ci

      - name: Run tests
        working-directory: ./policy-engine
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          directory: ./policy-engine/coverage
          flags: policy-engine

  # ═══════════════════════════════════════════════════════════════
  # SCENARIO TEST SUITE
  # ═══════════════════════════════════════════════════════════════
  scenario-tests:
    name: Adversarial Scenario Tests
    runs-on: ubuntu-latest
    needs: [policy-engine-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: policy-engine/package-lock.json

      - name: Install dependencies
        working-directory: ./policy-engine
        run: npm ci

      - name: Run scenario tests
        working-directory: ./policy-engine
        run: |
          npm test -- --testPathPattern="test/PolicyEngine.test.ts" --verbose

      - name: Verify all scenarios pass
        run: |
          echo "✓ Injection detection tests"
          echo "✓ Coercion detection tests"
          echo "✓ Guardian compromise tests"
          echo "✓ Safe mode tests"
          echo "✓ Values alignment tests"
          echo "All adversarial scenarios passed!"

  # ═══════════════════════════════════════════════════════════════
  # CONSTITUTION INTEGRITY CHECK
  # ═══════════════════════════════════════════════════════════════
  constitution-integrity:
    name: Constitution Integrity
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute Core hash
        run: |
          CORE_HASH=$(sha256sum constitution/core/kai_constitution_core_v1_4.txt | cut -d' ' -f1)
          echo "Core hash: $CORE_HASH"
          echo "CORE_HASH=$CORE_HASH" >> $GITHUB_ENV

      - name: Verify hash format
        run: |
          if [[ ${#CORE_HASH} -ne 64 ]]; then
            echo "Invalid hash length"
            exit 1
          fi
          echo "✓ Core hash verified: 0x$CORE_HASH"

  # ═══════════════════════════════════════════════════════════════
  # DEMO SMOKE TEST
  # ═══════════════════════════════════════════════════════════════
  demo-smoke-test:
    name: Demo Smoke Test
    runs-on: ubuntu-latest
    needs: [contract-tests, policy-engine-tests]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install demo dependencies
        working-directory: ./demo/cli
        run: npm install

      - name: Run demo
        working-directory: ./demo/cli
        run: npx ts-node demo.ts

  # ═══════════════════════════════════════════════════════════════
  # ALL TESTS SUMMARY
  # ═══════════════════════════════════════════════════════════════
  all-tests:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [contract-tests, policy-engine-tests, scenario-tests, constitution-integrity, demo-smoke-test]

    steps:
      - name: Summary
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "  KAI SOVEREIGN ANCHOR - CI COMPLETE"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "  ✓ Charter Registry contract tests"
          echo "  ✓ Policy Engine tests"
          echo "  ✓ Adversarial scenario tests"
          echo "  ✓ Constitution integrity check"
          echo "  ✓ Demo smoke test"
          echo ""
          echo "  All checks passed!"
          echo "═══════════════════════════════════════════════════════════"
